generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model AdminUser {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String   @map("password_hash")
  name         String
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  publicForms PublicForm[]
  auditLogs   AuditLog[]

  @@map("admin_users")
}

model CmpCredential {
  id                  String   @id @default(cuid())
  clientIdEncrypted   String   @map("client_id_encrypted")
  clientSecretEncrypted String @map("client_secret_encrypted")
  label               String   @default("Default")
  isActive            Boolean  @default(true) @map("is_active")
  lastTestedAt        DateTime? @map("last_tested_at")
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  publicForms PublicForm[]

  @@map("cmp_credentials")
}

enum AccessType {
  OPEN_URL
  ONE_TIME_URL
}

model PublicForm {
  id                  String     @id @default(cuid())
  title               String
  description         String?
  cmpTemplateId       String     @map("cmp_template_id")
  cmpTemplateName     String     @map("cmp_template_name")
  cmpWorkflowId       String?    @map("cmp_workflow_id")
  cmpWorkflowName     String?    @map("cmp_workflow_name")
  formFieldsSnapshot  Json       @map("form_fields_snapshot")
  accessType          AccessType @map("access_type")
  isActive            Boolean    @default(true) @map("is_active")
  createdById         String     @map("created_by_id")
  credentialId        String     @map("credential_id")
  createdAt           DateTime   @default(now()) @map("created_at")
  updatedAt           DateTime   @updatedAt @map("updated_at")

  createdBy   AdminUser     @relation(fields: [createdById], references: [id])
  credential  CmpCredential @relation(fields: [credentialId], references: [id])
  formUrls    FormUrl[]
  submissions Submission[]

  @@map("public_forms")
}

model FormUrl {
  id          String    @id @default(cuid())
  token       String    @unique
  formId      String    @map("form_id")
  isUsed      Boolean   @default(false) @map("is_used")
  usedAt      DateTime? @map("used_at")
  expiresAt   DateTime? @map("expires_at")
  createdAt   DateTime  @default(now()) @map("created_at")

  form        PublicForm   @relation(fields: [formId], references: [id], onDelete: Cascade)
  submissions Submission[]

  @@index([token])
  @@map("form_urls")
}

enum SubmissionStatus {
  PENDING
  SUBMITTED
  FAILED
  RETRYING
}

model Submission {
  id              String           @id @default(cuid())
  formId          String           @map("form_id")
  urlId           String           @map("url_id")
  formData        Json             @map("form_data")
  status          SubmissionStatus @default(PENDING)
  cmpWorkRequestId String?         @map("cmp_work_request_id")
  errorMessage    String?          @map("error_message")
  retryCount      Int              @default(0) @map("retry_count")
  nextRetryAt     DateTime?        @map("next_retry_at")
  submittedAt     DateTime         @default(now()) @map("submitted_at")
  completedAt     DateTime?        @map("completed_at")

  form PublicForm @relation(fields: [formId], references: [id])
  url  FormUrl    @relation(fields: [urlId], references: [id])

  @@index([status, nextRetryAt])
  @@map("submissions")
}

model AuditLog {
  id        String   @id @default(cuid())
  action    String
  entity    String
  entityId  String?  @map("entity_id")
  details   Json?
  adminId   String?  @map("admin_id")
  ipAddress String?  @map("ip_address")
  createdAt DateTime @default(now()) @map("created_at")

  admin AdminUser? @relation(fields: [adminId], references: [id])

  @@index([createdAt])
  @@index([entity, entityId])
  @@map("audit_logs")
}
